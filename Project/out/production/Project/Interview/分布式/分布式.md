### 一致性哈希

**概述**

对于mysql数据库来说，当一张表的记录非常多，一台服务器无法保存，那么就需要将表水平分成若干个。当然分表之后不能再去每个表上查询相应的记录，应该让一部分具有相似特点的记录（比如hash值接近）分布在同一个服务器上。

因此，要实现一种算法能**将固定的一部分请求落到同一台服务器上**，这样每台服务器固定处理一部分请求，起到了负载均衡的作用。而且在服务器数量伸缩时，大部分数据不用迁移。

普通的余数hash算法（以服务器数量为模）伸缩性很差，当新增或者下线服务器的时候，计算得hash值就会改变，导致记录-服务器的映射关系就会改变，导致记录失效。

一致性hash的空间是一个圆环，首尾相接。

**特性**

* 单调性：如果一部分请求通过hash分派到相应的服务器进行处理，当有服务器新增的时候，那么这部分请求只会被分派到之前的服务器和新增的服务器中
* 分散性：分布式环境中，客户端可能不知道所有服务器的存在，而只是将请求发送到能看到的服务器。这样可能导致同一个用户请求被路由到不同的服务器处理。好的hash算法应该尽量避免这种情况。
* 平衡性：负载均衡。**hash倾斜**是指由于hash计算结果不能均匀的分布在整个区间中，导致大部分请求分配在了同一个服务器中，而其他的服务器只处理很少的请求。 用虚拟节点的方式使区间尽量均匀分布在区间中。

## 分布式事务

### 两阶段提交

第一阶段，所有节点向事务管理器发布准备好或者没有准备好的消息。

第二阶段，事务管理器通知各资源管理器是commit还是rollback。

## CAP

### 1. 数据一致性

数据在各个节点之间是不是一样的，根据不同的一致性标准分为如下：

* 强一致性：每个节点的数据都是最新的
* 弱一致性：不能保证每个节点数据最新
* 最终一致性：不能保证节点数据马上被更新，但是最终在一定的时间内会更新

### 2. 可用性

节点能否被正常使用

### 3. 分区容忍性

当节点之间出现问题不能互通，能否继续正常运行

## nginx

nginx默认是七层的转发，添加插件后可以转发四层

### 高并发

**进程模型**：一个master进程，负责处理接收请求，然后将请求转发给多个worker进程（竞争），某个worker接收连接，通过socket与客户端通信，worker进程使用**IO多路复用技术**，使用**事件驱动机制（epoll）**，处理请求及回调。

### 负载均衡策略

* 轮询
* IP HASH
* 最少连接数
* fair
* URL HASH

### 后端健康检查

nginx_upstream_check_module 模块

## keepalived

Keepalived起初是为LVS设计的，专门用来监控集群系统中各个服务节点的状态，它根据TCP/IP参考模型的第三、第四层、第五层交换机制检测每个服务节点的状态，如果某个服务器节点出现异常，或者工作出现故障，Keepalived将检测到，并将出现的故障的服务器节点从集群系统中剔除，这些工作全部是自动完成的，不需要人工干涉，需要人工完成的只是修复出现故障的服务节点。

### VRRP

虚拟路由冗余协议，是一种容错性协议，它通过将多台设备虚拟化为一台设备，如果其中一台设备出现故障，那么另一台设备会迅速接替其工作，保证通讯的可靠性和连续性。

**虚拟设备：**由一个"主（Master）"设备和多个"备（Backup）"设备组成的一个虚拟网关。

**主设备（Master）：**负责转发数据报文和周期性向备设备发送VRRP协议报文。

**备设备（Backup）：**不负责转发数据报文，在Master设备发生故障的时候会通过选举形式成为新的Master设备，该角色会接收来自Master设备的VRRP报文并加以分析。

**虚拟IP：**配置在虚拟设备上的虚拟IP地址，一个虚拟设备可以拥有一个或者多个虚拟IP地址。

**选举机制**：

1. 判断虚拟ip是否是某个路由器的ip
2. 若没有ip拥有者，根据优先级确定（0-255越大优先级越高）
3. 根据ip地址大小确定

**工作过程**：

master节点拥有对外服务的虚拟IP，提供各种网络功能，并定期发送vrrp报文，通知备份组内其他设备自己工作正常；backup节点接受master的报文，监控master状态。master失效后，备份节点选举出优先级高的master。

抢占方式下，当backup收到vrrp报文时，发现自己优先级最高，则成为master。

非抢占需要等master故障才能成为master。

当backup定时器超时后还没收到master路由器的报文，再通过选举选出master。

